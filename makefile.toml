[tasks.build_ios_sim]
args = ["bundle", "--target", "aarch64-apple-ios-sim"]
command = "cargo"

[tasks.install_ios_sim]
command = "xcrun"
args = [
  "simctl",
  "install",
  "booted",
  "target/aarch64-apple-ios/debug/bundle/ios/unruggable.app",
]

[tasks.run_ios_sim]
args = ["simctl", "launch", "--console", "booted", "com.dioxuslabs"]
command = "xcrun"
dependencies = ["build_ios_sim", "install_ios_sim"]

[tasks.serve-sim]
dependencies = ["build_ios_sim", "install_ios_sim", "run_ios_sim"]

[tasks.build_ios_device]
script_runner = "bash"
script = '''
set -euo pipefail

: "${MIN_IOS:=12.0}"

# OK to export this globally — it influences Rust’s iOS link target
export IPHONEOS_DEPLOYMENT_TARGET="$MIN_IOS"

IOS_SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
IOS_CLANG="$(xcrun --sdk iphoneos -f clang)"
IOS_CLANGXX="$(xcrun --sdk iphoneos -f clang++)"
IOS_AR="$(xcrun --sdk iphoneos -f ar)"
IOS_RANLIB="$(xcrun --sdk iphoneos -f ranlib)"

# IMPORTANT: target-scoped env vars (do NOT override host CC/CFLAGS)
export "SDKROOT_aarch64_apple_ios=${IOS_SDKROOT}"
export "CC_aarch64_apple_ios=${IOS_CLANG}"
export "CXX_aarch64_apple_ios=${IOS_CLANGXX}"
export "AR_aarch64_apple_ios=${IOS_AR}"
export "RANLIB_aarch64_apple_ios=${IOS_RANLIB}"
export "CFLAGS_aarch64_apple_ios=-isysroot ${IOS_SDKROOT} -miphoneos-version-min=${MIN_IOS}"
export "CPPFLAGS_aarch64_apple_ios=-isysroot ${IOS_SDKROOT} -miphoneos-version-min=${MIN_IOS}"
export "LDFLAGS_aarch64_apple_ios=-isysroot ${IOS_SDKROOT} -miphoneos-version-min=${MIN_IOS}"

# Ensure final link uses the same min iOS
export RUSTFLAGS="${RUSTFLAGS:-} -C link-arg=-miphoneos-version-min=${MIN_IOS}"

# Clean once to purge stale objects
cargo clean

cargo bundle --target aarch64-apple-ios
'''



[tasks.code-sign-ios-device]
command = "./tools/make-entitlements.sh"

# god bless the crypto bros <3
# https://github.com/status-im/status-mobile/blob/6a5e718cd389f61d3708c4372856609afb40d11f/scripts/run-ios-device.sh#L6
[tasks.run-ios-device]
command = "./tools/run-ios-device.sh"

[tasks.serve-device]
dependencies = [
  "build_ios_device",
  "code-sign-ios-device",
  "run-ios-device",
]

[tasks.serve]
dependencies = [
  "run_ios_sim",
]
